<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Beloving World</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .handwriting { font-family: 'Dancing Script', cursive; }
        @keyframes marquee {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }
        .animate-marquee {
            animation: marquee 5s linear infinite;
        }
        [box-shadow] { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .modal-bg { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="transition-colors duration-500">

    <div id="app">
        <!-- Auth View -->
        <div id="auth-screen" class="min-h-screen flex flex-col items-center justify-center transition-colors duration-1000 bg-white">
            <div id="effects-container"></div>
            <h1 class="text-5xl font-bold mb-8 text-gray-800 text-center px-4">To our beloving World</h1>
            
            <div class="relative flex items-center">
                <i data-lucide="lock" class="absolute -left-12 text-gray-400" size="32"></i>
                <input 
                    type="password" 
                    id="passcode-input"
                    maxlength="6"
                    placeholder="••••••"
                    class="text-4xl tracking-widest text-center w-64 p-4 border-b-4 border-gray-300 focus:border-rose-400 outline-none bg-transparent transition-all"
                />
            </div>

            <div class="mt-12 h-10 text-center">
                <p id="auth-message" class="text-sm text-gray-400 italic">Enter your secret code to enter</p>
            </div>
        </div>

        <!-- Dashboard View (Hidden by default) -->
        <div id="dashboard-screen" class="hidden min-h-screen">
            <header class="relative w-full h-20 flex items-center justify-between px-8 border-b shadow-sm overflow-hidden bg-white/80 backdrop-blur">
                <div class="absolute inset-0 pointer-events-none">
                    <div class="h-1 w-full animate-marquee bg-gradient-to-r from-transparent via-rose-300 to-transparent opacity-50"></div>
                </div>

                <div class="flex gap-4 items-center z-10">
                    <i data-lucide="palette" class="opacity-70" size="20"></i>
                    <div class="flex gap-2">
                        <button onclick="setTheme('romantic')" class="w-6 h-6 rounded-full border-2 border-white bg-rose-400"></button>
                        <button onclick="setTheme('midnight')" class="w-6 h-6 rounded-full border-2 border-white bg-indigo-900"></button>
                        <button onclick="setTheme('sunset')" class="w-6 h-6 rounded-full border-2 border-white bg-orange-400"></button>
                    </div>
                </div>

                <h1 class="text-2xl font-bold tracking-[0.2em] uppercase flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-rose-500 animate-ping"></span>
                    <span class="hidden sm:inline">You are my World</span>
                    <span class="sm:hidden">Our World</span>
                    <span class="w-2 h-2 rounded-full bg-rose-500 animate-ping"></span>
                </h1>

                <div class="flex items-center gap-6 z-10">
                    <div class="text-right hidden md:block">
                        <p class="text-xs uppercase opacity-70">Next Event</p>
                        <p id="header-event" class="font-bold flex items-center gap-1 justify-end italic">No events</p>
                    </div>
                    <button onclick="openModal('settings')" class="p-2 hover:bg-black/5 rounded-full transition-colors">
                        <i data-lucide="settings" size="24"></i>
                    </button>
                </div>
            </header>

            <main class="max-w-7xl mx-auto p-8 pb-32">
                <div id="pins-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 min-h-[60vh]">
                    <!-- Pins inject here -->
                </div>

                <div class="fixed bottom-12 left-1/2 -translate-x-1/2 z-40 group">
                    <button class="w-16 h-16 bg-rose-500 text-white rounded-full shadow-2xl flex items-center justify-center hover:scale-110 transition-transform active:scale-95">
                        <i data-lucide="heart" fill="currentColor" size="32"></i>
                    </button>
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-4 flex gap-4 opacity-0 scale-0 group-hover:opacity-100 group-hover:scale-100 transition-all origin-bottom pointer-events-none group-hover:pointer-events-auto">
                        <button onclick="openModal('note')" class="flex items-center gap-2 bg-white text-gray-800 px-4 py-2 rounded-full shadow-lg hover:bg-rose-50 whitespace-nowrap border border-rose-100">
                            <i data-lucide="type" size="18"></i> Note
                        </button>
                        <button onclick="openModal('photo')" class="flex items-center gap-2 bg-white text-gray-800 px-4 py-2 rounded-full shadow-lg hover:bg-rose-50 whitespace-nowrap border border-rose-100">
                            <i data-lucide="image" size="18"></i> Photo
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <!-- Modals -->
        <div id="modal-container" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
            <!-- Modal Content Inject Here -->
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // CONFIG - Safely handle environment variables
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const CORRECT_CODE = "162930";
        const apiKey = ""; // Gemini API Key

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let user = null;
        let pins = [];
        let dates = [];

        // UI State
        const authScreen = document.getElementById('auth-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const passcodeIn = document.getElementById('passcode-input');
        const authMsg = document.getElementById('auth-message');
        const pinsGrid = document.getElementById('pins-grid');
        const modalCont = document.getElementById('modal-container');

        // Init Lucide
        lucide.createIcons();

        // 1. Auth Flow
        passcodeIn.addEventListener('input', (e) => {
            const val = e.target.value;
            if (val.length === 6) {
                if (val === CORRECT_CODE) {
                    authMsg.innerHTML = "Welcome to our world! ✨";
                    authMsg.className = "text-2xl text-rose-500 font-medium animate-bounce";
                    document.getElementById('effects-container').innerHTML = `<div class="fixed inset-0 pointer-events-none z-50"><div class="absolute animate-ping rounded-full bg-yellow-400 w-4 h-4 left-1/2 top-1/2"></div></div>`;
                    setTimeout(unlock, 1500);
                } else {
                    authMsg.innerHTML = "Sorry you are not the one who can enter";
                    authMsg.className = "text-lg text-red-500 font-medium italic";
                    passcodeIn.value = "";
                }
            }
        });

        async function unlock() {
            try {
                if (initialToken) {
                    await signInWithCustomToken(auth, initialToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth failed", err);
                // Fallback to anonymous if custom token fails
                await signInAnonymously(auth);
            }
        }

        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                authScreen.classList.add('hidden');
                dashboardScreen.classList.remove('hidden');
                startSync();
            }
        });

        // 2. Data Sync
        function startSync() {
            if (!user) return;

            const pinsRef = collection(db, 'artifacts', appId, 'public', 'data', 'pins');
            onSnapshot(pinsRef, (snap) => {
                pins = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderPins();
            }, (err) => console.error("Pins Sync Error", err));

            const datesRef = collection(db, 'artifacts', appId, 'public', 'data', 'dates');
            onSnapshot(datesRef, (snap) => {
                dates = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderDates();
            }, (err) => console.error("Dates Sync Error", err));
        }

        function renderPins() {
            pinsGrid.innerHTML = pins.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).map(pin => {
                if(pin.type === 'note') {
                    const style = `font-size: ${pin.fontSize || '16px'}; font-weight: ${pin.bold ? 'bold' : 'normal'}; text-decoration: ${pin.underline ? 'underline' : 'none'};`;
                    const fontClass = pin.fontStyle === 'handwriting' ? 'handwriting' : '';
                    const paperClass = pin.template === 'torn' ? 'bg-[#fff9c4] border-l-4 border-dashed border-gray-400' : 'bg-white';
                    
                    return `
                        <div class="group p-6 rounded-lg shadow-lg relative transition-transform hover:-rotate-1 hover:scale-105 ${paperClass}">
                            <button onclick="deletePin('${pin.id}')" class="absolute -top-2 -right-2 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 z-20 shadow-md transition-opacity"><i data-lucide="x" size="12"></i></button>
                            <p class="whitespace-pre-wrap text-gray-800 ${fontClass}" style="${style}">${pin.content}</p>
                        </div>
                    `;
                } else {
                    const frameStyle = `border: ${pin.frameWidth || 8}px solid ${pin.frameColor || '#fff'}; border-radius: ${pin.frameType === 'round' ? '999px' : '8px'}; aspect-ratio: ${pin.frameType === 'round' ? '1/1' : 'auto'};`;
                    return `
                        <div class="group p-6 rounded-lg shadow-lg relative transition-transform hover:-rotate-1 hover:scale-105 bg-white" style="${frameStyle}">
                            <button onclick="deletePin('${pin.id}')" class="absolute -top-2 -right-2 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 z-20 shadow-md transition-opacity"><i data-lucide="x" size="12"></i></button>
                            <div class="h-48 bg-gray-200 rounded flex items-center justify-center overflow-hidden mb-2 relative">
                                <i data-lucide="image" class="text-gray-400" size="40"></i>
                                <div class="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <p class="text-white text-xs px-2 py-1 bg-black/40 rounded uppercase tracking-tighter">${pin.pictureTheme || 'Moment'}</p>
                                </div>
                            </div>
                            <p class="text-center italic text-sm text-gray-600">"${pin.caption || ''}"</p>
                        </div>
                    `;
                }
            }).join('');
            lucide.createIcons();
        }

        function renderDates() {
            const sorted = dates.sort((a,b) => new Date(a.date) - new Date(b.date));
            const header = document.getElementById('header-event');
            if(sorted[0]) {
                header.innerHTML = `<i data-lucide="clock" size="14"></i> ${sorted[0].title}`;
                header.classList.remove('italic');
            } else {
                header.innerHTML = "No events";
                header.classList.add('italic');
            }
            lucide.createIcons();
        }

        // Global functions
        window.deletePin = async (id) => {
            if (!user) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pins', id));
        };
        
        window.deleteDate = async (id) => {
            if (!user) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'dates', id));
        };

        window.setTheme = (t) => {
            const themes = {
                romantic: "bg-rose-50 text-rose-900 border-rose-200",
                midnight: "bg-slate-900 text-indigo-100 border-indigo-900",
                sunset: "bg-orange-50 text-orange-900 border-orange-200"
            };
            document.body.className = `transition-colors duration-500 ${themes[t]}`;
        };

        window.openModal = (type) => {
            modalCont.classList.remove('hidden');
            if(type === 'note') {
                modalCont.innerHTML = `
                    <div class="bg-white rounded-2xl w-full max-w-lg overflow-hidden flex flex-col shadow-2xl text-gray-800">
                        <div class="p-4 border-b flex justify-between items-center bg-rose-50">
                            <h3 class="font-bold flex items-center gap-2"><i data-lucide="type" size="18"></i> Create a Love Note</h3>
                            <button onclick="closeModal()"><i data-lucide="x"></i></button>
                        </div>
                        <div class="p-6 space-y-4">
                            <textarea id="note-text" class="w-full h-48 p-4 border rounded-lg outline-none focus:ring-2 focus:ring-rose-200 transition-all" placeholder="Start writing your heart out..."></textarea>
                            <div class="flex gap-2">
                                <button id="ai-btn" class="flex-1 py-2 bg-indigo-500 text-white rounded-lg flex items-center justify-center gap-2 hover:bg-indigo-600 transition-colors"><i data-lucide="sparkles" size="16"></i> AI Letter</button>
                                <button onclick="saveNote()" class="flex-1 py-2 bg-rose-500 text-white rounded-lg hover:bg-rose-600 transition-colors">Pin to Board</button>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('ai-btn').onclick = async () => {
                    const btn = document.getElementById('ai-btn');
                    btn.innerText = "Writing...";
                    btn.disabled = true;
                    try {
                        const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ contents: [{ parts: [{ text: "Write a short romantic love letter for a long distance couple. Make it emotional and poetic." }] }] })
                        });
                        const d = await r.json();
                        document.getElementById('note-text').value = d.candidates[0].content.parts[0].text;
                    } catch(e) {
                        console.error("AI Error", e);
                    }
                    btn.innerHTML = `<i data-lucide="sparkles" size="16"></i> AI Letter`;
                    btn.disabled = false;
                    lucide.createIcons();
                }
            } else if (type === 'photo') {
                modalCont.innerHTML = `
                    <div class="bg-white rounded-2xl w-full max-w-lg overflow-hidden shadow-2xl text-gray-800">
                        <div class="p-4 border-b flex justify-between items-center bg-blue-50">
                            <h3 class="font-bold flex items-center gap-2"><i data-lucide="image" size="18"></i> Pin a Moment</h3>
                            <button onclick="closeModal()"><i data-lucide="x"></i></button>
                        </div>
                        <div class="p-6 space-y-4">
                            <input id="photo-caption" placeholder="Caption this memory..." class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-100 outline-none" />
                            <select id="photo-theme" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-100 outline-none">
                                <option>Tokyo Sunset</option><option>Summer Vibe</option><option>Neon Nights</option><option>Retro Polaroid</option>
                            </select>
                            <button onclick="savePhoto()" class="w-full py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">Pin Photo</button>
                        </div>
                    </div>
                `;
            } else if (type === 'settings') {
                modalCont.innerHTML = `
                    <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-2xl text-gray-800">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h3 class="font-bold flex items-center gap-2"><i data-lucide="calendar" size="18"></i> Dates & Events</h3>
                            <button onclick="closeModal()"><i data-lucide="x"></i></button>
                        </div>
                        <div class="p-6 space-y-4">
                            <div id="dates-list" class="max-h-40 overflow-y-auto space-y-2 border rounded p-2 bg-gray-50"></div>
                            <div class="pt-4 border-t space-y-2">
                                <input id="date-title" placeholder="Event name (e.g., Our Anniversary)" class="w-full p-2 border rounded outline-none" />
                                <input id="date-val" type="date" class="w-full p-2 border rounded outline-none" />
                                <button onclick="saveDate()" class="w-full py-2 bg-rose-500 text-white rounded-lg hover:bg-rose-600 transition-colors">Add Event</button>
                            </div>
                        </div>
                    </div>
                `;
                const list = document.getElementById('dates-list');
                list.innerHTML = dates.length ? dates.map(d => `
                    <div class="flex justify-between items-center p-2 bg-white rounded border shadow-sm">
                        <div class="text-sm">
                            <div class="font-bold">${d.title}</div>
                            <div class="text-xs text-gray-500">${d.date}</div>
                        </div>
                        <button onclick="deleteDate('${d.id}')" class="text-red-400 hover:text-red-600 transition-colors">
                            <i data-lucide="trash-2" size="16"></i>
                        </button>
                    </div>
                `).join('') : '<p class="text-center text-gray-400 text-sm py-4 italic">No dates saved yet</p>';
            }
            lucide.createIcons();
        };

        window.closeModal = () => modalCont.classList.add('hidden');

        window.saveNote = async () => {
            const content = document.getElementById('note-text').value;
            if(!content.trim() || !user) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pins'), {
                type: 'note', content, createdAt: serverTimestamp(), fontStyle: 'sans', fontSize: '16px'
            });
            closeModal();
        };

        window.savePhoto = async () => {
            const caption = document.getElementById('photo-caption').value;
            const pictureTheme = document.getElementById('photo-theme').value;
            if(!user) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pins'), {
                type: 'photo', caption, pictureTheme, createdAt: serverTimestamp()
            });
            closeModal();
        };

        window.saveDate = async () => {
            const title = document.getElementById('date-title').value;
            const date = document.getElementById('date-val').value;
            if(!title || !date || !user) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'dates'), {
                title, date, createdAt: serverTimestamp()
            });
            closeModal();
        };
    </script>
</body>
</html>