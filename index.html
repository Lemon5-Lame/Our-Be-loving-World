<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To Our Beloving World</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Use Compat SDKs for global 'firebase' namespace -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Inter:wght@300;400;600&family=Playfair+Display:ital@1&display=swap');

        :root {
            --primary-bg: #fff5f5;
            --accent: #ff4d6d;
            --text: #590d22;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text);
            transition: all 0.5s ease;
            overflow-x: hidden;
        }

        /* Running Light Effect */
        .running-light {
            background: linear-gradient(90deg, #ff4d6d, #ff8fa3, #ff4d6d);
            background-size: 200% auto;
            color: transparent;
            -webkit-background-clip: text;
            animation: shine 3s linear infinite;
        }

        @keyframes shine {
            to { background-position: 200% center; }
        }

        /* Passcode Page */
        #auth-overlay {
            position: fixed;
            inset: 0;
            background: #fff5f5;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease;
        }

        .frown {
            position: absolute;
            font-size: 2rem;
            animation: fall 2s linear forwards;
            pointer-events: none;
        }

        @keyframes fall {
            to { transform: translateY(100vh) rotate(360deg); }
        }

        .firework {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: explode 1s ease-out forwards;
            pointer-events: none;
        }

        @keyframes explode {
            to { transform: translate(var(--x), var(--y)); opacity: 0; }
        }

        /* Note Templates */
        .torn-paper {
            background: #fff;
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            mask-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 100" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg"><path d="M0 0 Q 5 2 10 0 T 20 0 T 30 0 T 40 0 T 50 0 T 60 0 T 70 0 T 80 0 T 90 0 T 100 0 V 100 Q 95 98 90 100 T 80 100 T 70 100 T 60 100 T 50 100 T 40 100 T 30 100 T 20 100 T 10 100 T 0 100 Z" fill="black"/></svg>');
            padding: 2rem;
        }

        /* Photo Frames */
        .frame-round { border-radius: 50%; overflow: hidden; border: 8px solid white; aspect-ratio: 1/1; }
        .frame-square { border-radius: 4px; border: 12px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        /* Themes */
        .theme-midnight { --primary-bg: #0b090a; --accent: #a4161a; --text: #f5f3f4; }
        .theme-sunset { --primary-bg: #ffecd2; --accent: #fcb045; --text: #603813; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Passcode Section -->
    <div id="auth-overlay">
        <h1 class="text-4xl font-bold mb-8 text-rose-600">To our beloving World</h1>
        <div class="flex gap-2 mb-4">
            <input type="password" id="pass-input" maxlength="6" class="w-48 text-center text-3xl tracking-widest border-2 border-rose-300 rounded-full py-2 focus:outline-none focus:border-rose-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button onclick="checkPasscode()" class="bg-rose-500 text-white px-8 py-2 rounded-full font-semibold hover:bg-rose-600 transition">Enter Our World</button>
        <p id="auth-msg" class="mt-4 font-medium h-6"></p>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
        <header class="p-6 bg-white/80 backdrop-blur shadow-sm sticky top-0 z-50 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="dropdown relative">
                    <button class="p-2 hover:bg-rose-100 rounded-full transition" title="Themes">üé®</button>
                    <div id="theme-menu" class="hidden absolute top-10 left-0 bg-white shadow-xl rounded-lg p-2 border border-rose-100 w-40">
                        <button onclick="setTheme('default')" class="w-full text-left p-2 hover:bg-rose-50 rounded">üå∏ Rose Petal</button>
                        <button onclick="setTheme('midnight')" class="w-full text-left p-2 hover:bg-rose-50 rounded">üåô Midnight Sky</button>
                        <button onclick="setTheme('sunset')" class="w-full text-left p-2 hover:bg-rose-50 rounded">üåÖ Sunset Vibe</button>
                    </div>
                </div>
            </div>

            <h1 class="text-3xl font-bold running-light italic font-serif text-center px-4">You are my world</h1>

            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <p id="next-date" class="text-xs font-semibold uppercase opacity-70">Next Event</p>
                    <p id="days-count" class="text-sm font-bold">Loading...</p>
                </div>
                <button onclick="toggleDatesModal()" class="p-2 hover:bg-rose-100 rounded-full">üìÖ</button>
            </div>
        </header>

        <main class="max-w-6xl mx-auto p-4 sm:p-8">
            <div id="board" class="columns-1 md:columns-2 lg:columns-3 gap-6 space-y-6">
                <!-- Pinned items dynamically loaded -->
            </div>

            <!-- Action Bar -->
            <div class="fixed bottom-8 left-1/2 -translate-x-1/2 flex items-center gap-6 bg-white/90 backdrop-blur-md px-8 py-4 rounded-full shadow-2xl border border-rose-100">
                <button onclick="openNoteModal()" class="flex flex-col items-center group">
                    <span class="text-2xl group-hover:scale-125 transition">‚úçÔ∏è</span>
                    <span class="text-[10px] uppercase font-bold text-rose-600">Write</span>
                </button>
                <div class="text-rose-400 text-2xl animate-pulse">‚ù§Ô∏è</div>
                <button onclick="openPhotoModal()" class="flex flex-col items-center group">
                    <span class="text-2xl group-hover:scale-125 transition">üì∏</span>
                    <span class="text-[10px] uppercase font-bold text-rose-600">Photo</span>
                </button>
            </div>
        </main>
    </div>

    <!-- Modals Container -->
    <div id="modal-container" class="fixed inset-0 bg-black/50 z-[2000] hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-xl p-6 relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-xl">‚úï</button>
            <div id="modal-content"></div>
        </div>
    </div>

    <script>
        // --- Firebase & App Initialization ---
        const firebaseConfig = JSON.parse(__firebase_config);
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'shared-love-world';
        const apiKey = ""; 

        let user = null;

        // --- Auth Logic (Globally defined) ---
        window.checkPasscode = async () => {
            const input = document.getElementById('pass-input').value;
            const msg = document.getElementById('auth-msg');
            
            if (input === '162930') {
                msg.innerText = "Welcome to our world!";
                msg.className = "mt-4 font-bold text-green-500 text-xl animate-bounce";
                createFireworks();
                setTimeout(() => {
                    document.getElementById('auth-overlay').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('auth-overlay').remove();
                        document.getElementById('main-content').classList.remove('hidden');
                        initApp();
                    }, 800);
                }, 1200);
            } else {
                msg.innerText = "Sorry you are not the one who can enter";
                msg.className = "mt-4 font-bold text-red-500";
                createFrowns();
                document.getElementById('pass-input').value = '';
            }
        };

        function createFireworks() {
            for (let i = 0; i < 40; i++) {
                const f = document.createElement('div');
                f.className = 'firework';
                f.style.left = '50%';
                f.style.top = '50%';
                f.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 60%)`;
                f.style.setProperty('--x', `${(Math.random() - 0.5) * 600}px`);
                f.style.setProperty('--y', `${(Math.random() - 0.5) * 600}px`);
                document.body.appendChild(f);
                setTimeout(() => f.remove(), 1000);
            }
        }

        function createFrowns() {
            for (let i = 0; i < 15; i++) {
                const f = document.createElement('div');
                f.className = 'frown';
                f.innerText = '‚òπÔ∏è';
                f.style.left = Math.random() * 100 + 'vw';
                f.style.top = '-50px';
                document.body.appendChild(f);
                setTimeout(() => f.remove(), 2000);
            }
        }

        async function initApp() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
            } catch (err) {
                console.error("Auth error:", err);
            }
            
            auth.onAuthStateChanged(u => {
                user = u;
                if (user) {
                    subscribeToBoard();
                    subscribeToDates();
                }
            });
        }

        function subscribeToBoard() {
            const col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('board');
            col.onSnapshot(snapshot => {
                const board = document.getElementById('board');
                board.innerHTML = '';
                const items = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}))
                    .sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                items.forEach(item => {
                    board.appendChild(createBoardElement(item));
                });
            }, err => console.error("Firestore error:", err));
        }

        function createBoardElement(item) {
            const el = document.createElement('div');
            el.className = 'break-inside-avoid mb-6 transition-all hover:scale-[1.01]';
            
            if (item.type === 'note') {
                el.innerHTML = `
                    <div class="torn-paper" style="font-family: ${item.font || 'Inter'}; font-size: ${item.size || 16}px; font-weight: ${item.bold?'bold':'normal'}; text-decoration: ${item.underline?'underline':'none'}">
                        <p class="whitespace-pre-wrap">${item.content}</p>
                        <div class="mt-6 flex justify-between items-center opacity-40 text-[10px]">
                            <span>${new Date(item.timestamp).toLocaleDateString()}</span>
                            <button onclick="deleteItem('${item.id}')" class="hover:text-red-500">DELETE üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            } else {
                el.innerHTML = `
                    <div class="frame-${item.frame || 'square'} shadow-lg" style="background-color: ${item.frameColor || 'white'}">
                        <div class="relative group">
                            <img src="${item.url}" class="w-full block object-cover" loading="lazy" onerror="this.src='https://via.placeholder.com/400x300?text=Invalid+Image+URL'">
                            <div class="p-4 bg-white">
                                <p class="text-sm font-medium italic mb-1">${item.caption || ''}</p>
                                <p class="text-[10px] opacity-40 uppercase tracking-wider">${item.theme || 'Vibe'}</p>
                                <button onclick="deleteItem('${item.id}')" class="absolute top-2 right-2 hidden group-hover:flex bg-red-500 text-white rounded-full w-6 h-6 items-center justify-center text-xs shadow-lg">‚úï</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            return el;
        }

        window.deleteItem = async (id) => {
            if (!confirm("Are you sure you want to remove this moment?")) return;
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('board').doc(id).delete();
        };

        window.setTheme = (theme) => {
            document.body.className = theme === 'default' ? 'min-h-screen' : `min-h-screen theme-${theme}`;
            document.getElementById('theme-menu').classList.add('hidden');
        };

        document.querySelector('.dropdown button').onclick = (e) => {
            e.stopPropagation();
            document.getElementById('theme-menu').classList.toggle('hidden');
        };

        window.generateAILetter = async () => {
            const btn = document.getElementById('ai-btn');
            const area = document.getElementById('note-content');
            if (!area) return;
            
            const originalText = btn.innerText;
            btn.innerText = "Writing...";
            btn.disabled = true;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: "Write a short, heart-melting and poetic love letter for a long distance relationship. Mention missing their touch. Max 40 words." }] }]
                    })
                });
                const data = await response.json();
                area.value = data.candidates?.[0]?.content?.parts?.[0]?.text || "My love, distance is but a test of how far love can travel. I miss you more than words.";
            } catch (e) {
                console.error(e);
                area.value = "Distance means so little when someone means so much. Thinking of you always.";
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        window.openNoteModal = () => {
            const container = document.getElementById('modal-container');
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <h3 class="text-xl font-bold mb-4 text-rose-600">Write a Moment</h3>
                <textarea id="note-content" class="w-full h-40 p-4 border border-rose-100 rounded-xl mb-4 focus:ring-2 ring-rose-300 outline-none" placeholder="What's on your heart?"></textarea>
                <div class="flex flex-wrap gap-2 mb-6">
                    <button id="ai-btn" onclick="generateAILetter()" class="bg-purple-100 text-purple-600 px-4 py-1.5 rounded-full text-sm font-bold hover:bg-purple-200 transition">‚ú® AI Love Letter</button>
                    <select id="font-style" class="border rounded px-2 py-1 text-sm bg-white">
                        <option value="Inter">Modern</option>
                        <option value="'Dancing Script'">Cursive</option>
                        <option value="'Playfair Display'">Elegant</option>
                    </select>
                    <input type="number" id="font-size" value="18" class="w-16 border rounded px-2 text-sm">
                    <button onclick="this.classList.toggle('bg-rose-200')" id="is-bold" class="w-8 h-8 border rounded font-bold">B</button>
                    <button onclick="this.classList.toggle('bg-rose-200')" id="is-underline" class="w-8 h-8 border rounded underline">U</button>
                </div>
                <button onclick="saveNote()" class="w-full bg-rose-500 text-white py-3 rounded-xl font-bold hover:bg-rose-600 shadow-lg transition">Pin to Our Board</button>
            `;
            container.classList.replace('hidden', 'flex');
        };

        window.openPhotoModal = () => {
            const container = document.getElementById('modal-container');
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <h3 class="text-xl font-bold mb-4 text-rose-600">Share a Vision</h3>
                <div class="mb-4">
                    <label class="block text-xs font-bold mb-1 opacity-60">IMAGE URL</label>
                    <input type="text" id="photo-url" class="w-full p-3 border border-rose-100 rounded-xl" placeholder="Paste link (jpg, png, gif)...">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-bold mb-1 opacity-60">FRAME STYLE</label>
                        <select id="frame-type" class="w-full border rounded p-2 bg-white">
                            <option value="square">Square Polaroid</option>
                            <option value="round">Circular Frame</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold mb-1 opacity-60">PICTURE THEME</label>
                        <select id="photo-vibe" class="w-full border rounded p-2 bg-white">
                            <option>Tokyo Sunset</option>
                            <option>Summer Vibe</option>
                            <option>Cozy Rain</option>
                            <option>Midnight Walk</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-xs font-bold mb-1 opacity-60">CAPTION</label>
                    <input type="text" id="photo-caption" class="w-full p-3 border border-rose-100 rounded-xl" placeholder="A memory of us...">
                </div>
                <button onclick="savePhoto()" class="w-full bg-rose-500 text-white py-3 rounded-xl font-bold hover:bg-rose-600 shadow-lg transition">Pin Photo</button>
            `;
            container.classList.replace('hidden', 'flex');
        };

        window.saveNote = async () => {
            const content = document.getElementById('note-content').value;
            if(!content.trim()) return;
            const data = {
                type: 'note',
                content,
                font: document.getElementById('font-style').value,
                size: parseInt(document.getElementById('font-size').value) || 16,
                bold: document.getElementById('is-bold').classList.contains('bg-rose-200'),
                underline: document.getElementById('is-underline').classList.contains('bg-rose-200'),
                timestamp: Date.now()
            };
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('board').add(data);
            closeModal();
        };

        window.savePhoto = async () => {
            const url = document.getElementById('photo-url').value;
            if(!url.trim()) return;
            const data = {
                type: 'photo',
                url,
                frame: document.getElementById('frame-type').value,
                theme: document.getElementById('photo-vibe').value,
                caption: document.getElementById('photo-caption').value,
                timestamp: Date.now()
            };
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('board').add(data);
            closeModal();
        };

        window.closeModal = () => {
            const container = document.getElementById('modal-container');
            container.classList.replace('flex', 'hidden');
        };

        function subscribeToDates() {
            const col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('dates');
            col.onSnapshot(snapshot => {
                const dates = snapshot.docs.map(doc => doc.data());
                const counter = document.getElementById('days-count');
                const title = document.getElementById('next-date');
                
                if (dates.length > 0) {
                    const sorted = dates.sort((a,b) => new Date(a.date) - new Date(b.date));
                    const next = sorted.find(d => new Date(d.date) >= new Date().setHours(0,0,0,0));
                    if (next) {
                        const diff = Math.ceil((new Date(next.date) - new Date()) / (1000 * 60 * 60 * 24));
                        title.innerText = next.title;
                        counter.innerText = diff === 0 ? "Today is the day! ‚ù§Ô∏è" : `${diff} Days Left`;
                    } else {
                        counter.innerText = "No upcoming events";
                    }
                } else {
                    counter.innerText = "No dates set";
                }
            });
        }

        window.toggleDatesModal = () => {
            const container = document.getElementById('modal-container');
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <h3 class="text-xl font-bold mb-4 text-rose-600">Set Important Dates</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold mb-1 opacity-60">EVENT NAME</label>
                        <input type="text" id="date-title" class="w-full p-2 border border-rose-100 rounded-lg" placeholder="e.g. Next Meeting">
                    </div>
                    <div>
                        <label class="block text-xs font-bold mb-1 opacity-60">WHEN</label>
                        <input type="date" id="date-val" class="w-full p-2 border border-rose-100 rounded-lg">
                    </div>
                    <button onclick="addDate()" class="w-full bg-rose-500 text-white py-3 rounded-xl font-bold hover:bg-rose-600 shadow-lg">Add Reminder</button>
                </div>
            `;
            container.classList.replace('hidden', 'flex');
        };

        window.addDate = async () => {
            const title = document.getElementById('date-title').value;
            const date = document.getElementById('date-val').value;
            if(!title || !date) return;
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('dates').add({title, date});
            closeModal();
        };

        // Close dropdown when clicking outside
        window.addEventListener('click', () => {
            document.getElementById('theme-menu').classList.add('hidden');
        });
    </script>
</body>
</html>